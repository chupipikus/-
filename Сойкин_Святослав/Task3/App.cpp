#include "App.h"
#include "Utils.h"

App::App() {}

void App::printList(const list<Request>& lst, const string& title) const {
    cout << "     " << title << "\n"
        << "     +" << setfill('-') << setw(112) << "-" << "+"
        << setfill(' ') << "\n";

    int row = 1;
    for (const auto& r : lst) {
        cout << " " << setfill('0') << setw(3) << row++ << setfill(' ')
            << " | ID: " << setw(2) << r.id
            << " | ?????: " << setw(19) << r.destination
            << " | ?????: " << setw(8) << r.flightNum
            << " | ????????: " << setw(15) << r.passenger
            << " | ?????: " << r.date.toString() << " |\n";
    }
    cout << "     +" << setfill('-') << setw(112) << "-" << "+"
        << setfill(' ') << "\n";
}

void App::doAddRequest() {
    cls();
    showNavBarMessage(hintColor, "    ????????? ????? ????????");
    printList(getRequests(), "Current requests");

    cout << "\n    ??????? ?????? ??????:\n";
    try {
        requests_.addRequest();
        cout << color(sumColor) << "    ???????? ???????? ?????????\n" << color(mainColor);
    } catch (const exception& e) {
        cout << color(errColor) << "    ??????: " << e.what() << color(mainColor) << "\n";
    }

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "?????????? ?????? ????????");
}

void App::doDeleteById() {
    cls();
    showNavBarMessage(hintColor, "    ??????? ???????? ?? ID");
    printList(getRequests(), "Current requests");

    if (getRequests().empty()) {
        cout << color(errColor) << "    ?????? ?????\n" << color(mainColor);
        getKey();
        return;
    }

    cout << "\n    ??????? ID ???????? ??? ????????: " << color(infoColor);
    int id;
    if (!(cin >> id)) {
        cin.clear();
        cin.ignore(cin.rdbuf()->in_avail(), '\n');
        cout << color(mainColor) << color(errColor) << "    ???????? ?????? ID\n" << color(mainColor);
        getKey();
        return;
    }
    cin.ignore(cin.rdbuf()->in_avail(), '\n');

    try {
        requests_.deleteById(id);
        cout << color(mainColor) << color(sumColor) << "    ???????? ID " << id << " ???????\n" << color(mainColor);
    } catch (const exception& e) {
        cout << color(mainColor) << color(errColor) << "    ??????: " << e.what() << color(mainColor) << "\n";
    }

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "?????????? ?????? ????????");
}

void App::doSelectByFlight() {
    cls();
    showNavBarMessage(hintColor, "    ?????? ???????? ?? ?????? ?????");
    printList(getRequests(), "Current requests");

    if (getRequests().empty()) {
        cout << color(errColor) << "    ?????? ?????\n" << color(mainColor);
        getKey();
        return;
    }

    cout << "\n    ??????? ????? ????? (??????? PO-xxxxK): " << color(infoColor);
    string flight;
    getline(cin, flight);
    if (cin.fail()) {
        cin.clear();
        cin.ignore(cin.rdbuf()->in_avail(), '\n');
        cout << color(mainColor) << color(errColor) << "    ???????? ?????\n" << color(mainColor);
        getKey();
        return;
    }

    if (flight.empty()) {
        cout << color(mainColor) << color(errColor) << "    ????? ????? ?? ????? ????? ?????\n" << color(mainColor);
        getKey();
        return;
    }

    auto res = requests_.selectByFlight(flight);
    cout << color(mainColor);
    if (res.empty()) {
        cout << "    ?? ??????? ???????? ?? ??????: " << flight << "\n";
    }
    printList(res, "???????? ?? ?????? " + flight);
    getKey();
}

void App::doSelectByDate() {
    cls();
    showNavBarMessage(hintColor, "    ?????? ???????? ?? ????");
    printList(getRequests(), "Current requests");

    if (getRequests().empty()) {
        cout << color(errColor) << "    ?????? ?????\n" << color(mainColor);
        getKey();
        return;
    }

    cout << "\n    ??????? ????? (???? ?????? ??? - day month year): " << color(infoColor);
    short day, month, year;
    if (!(cin >> day >> month >> year)) {
        cin.clear();
        cin.ignore(cin.rdbuf()->in_avail(), '\n');
        cout << color(mainColor) << color(errColor) << "    ???????? ?????? ?????\n" << color(mainColor);
        getKey();
        return;
    }
    cin.ignore(cin.rdbuf()->in_avail(), '\n');

    if (day < 1 || day > 31 || month < 1 || month > 12 || year < 1900 || year > 2100) {
        cout << color(mainColor) << color(errColor) << "    ???????? ???????? ????: day=[1-31], month=[1-12], year=[1900-2100]\n" << color(mainColor);
        getKey();
        return;
    }

    try {
        Date date(day, month, year);
        auto res = requests_.selectByDate(date);
        cout << color(mainColor);
        if (res.empty()) {
            cout << "    ?? ??????? ???????? ?? ????: " << date.toString() << "\n";
        }
        printList(res, "???????? ?? ???? " + date.toString());
    } catch (const exception& e) {
        cout << color(mainColor) << color(errColor) << "    ??????: " << e.what() << color(mainColor) << "\n";
    }
    getKey();
}

void App::doSelectByPassenger() {
    cls();
    showNavBarMessage(hintColor, "    ?????? ???????? ?? ???? ?????????");
    printList(getRequests(), "Current requests");

    if (getRequests().empty()) {
        cout << color(errColor) << "    ?????? ?????\n" << color(mainColor);
        getKey();
        return;
    }

    cout << "\n    ??????? ??? ??????????: " << color(infoColor);
    string pass;
    getline(cin, pass);
    if (cin.fail()) {
        cin.clear();
        cin.ignore(cin.rdbuf()->in_avail(), '\n');
        cout << color(mainColor) << color(errColor) << "    ???????? ?????\n" << color(mainColor);
        getKey();
        return;
    }

    if (pass.empty()) {
        cout << color(mainColor) << color(errColor) << "    ??? ?????????? ?? ????? ????? ?????\n" << color(mainColor);
        getKey();
        return;
    }

    auto res = requests_.selectByPassenger(pass);
    cout << color(mainColor);
    if (res.empty()) {
        cout << "    ?? ??????? ???????? ?? ?????????: " << pass << "\n";
    }
    printList(res, "???????? ?? ?????????? " + pass);
    getKey();
}

void App::doSortById() {
    cls();
    showNavBarMessage(hintColor, "    ?????????? ???????? ?? ID");
    printList(getRequests(), "Current requests");

    requests_.sortById();
    cout << color(sumColor) << "    ??????????? ?? ID\n" << color(mainColor);

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "??????????? ????????");
}

void App::doSortByDate() {
    cls();
    showNavBarMessage(hintColor, "    ?????????? ???????? ?? ????");
    printList(getRequests(), "Current requests");

    requests_.sortByDate();
    cout << color(sumColor) << "    ??????????? ?? ????\n" << color(mainColor);

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "??????????? ????????");
}

void App::doSortByDestination() {
    cls();
    showNavBarMessage(hintColor, "    ?????????? ???????? ?? ???????");
    printList(getRequests(), "Current requests");

    requests_.sortByDestination();
    cout << color(sumColor) << "    ??????????? ?? ???????\n" << color(mainColor);

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "??????????? ????????");
}

void App::doChangeRequest() {
    cls();
    showNavBarMessage(hintColor, "    ?????????? ????????");
    printList(getRequests(), "Current requests");

    if (getRequests().empty()) {
        cout << color(errColor) << "    ?????? ?????\n" << color(mainColor);
        getKey();
        return;
    }

    cout << "\n    ??????? ID ???????? ??? ??????????: " << color(infoColor);
    int id;
    if (!(cin >> id)) {
        cin.clear();
        cin.ignore(cin.rdbuf()->in_avail(), '\n');
        cout << color(mainColor) << color(errColor) << "    ???????? ?????? ID\n" << color(mainColor);
        getKey();
        return;
    }
    cin.ignore(cin.rdbuf()->in_avail(), '\n');

    cout << color(mainColor) << "\n    ??????? ????? ?????? ??????:\n";
    try {
        requests_.changeRequest(id);
        cout << color(sumColor) << "    ???????? ID " << id << " ?????? ?????????\n" << color(mainColor);
    } catch (const exception& e) {
        cout << color(errColor) << "    ??????: " << e.what() << color(mainColor) << "\n";
    }

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "?????????? ????????");
}

void App::doSaveToBinaryFixed() {
    cls();
    showNavBarMessage(hintColor, "    ?????? ???????? ? ???????? ????");
    printList(getRequests(), "Current requests");

    try {
        requests_.saveToBinaryFixed(binFile_);
        cout << color(sumColor) << "    ????????? ? " << binFile_ << color(mainColor) << "\n";
    } catch (const exception& e) {
        cout << color(errColor) << "    ??????: " << e.what() << color(mainColor) << "\n";
    }

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "?????? ????????");
}

void App::doLoadFromBinaryFixed() {
    cls();
    showNavBarMessage(hintColor, "    ???????? ???????? ?? ???????? ????");
    printList(getRequests(), "Current requests");

    try {
        requests_.loadFromBinaryFixed(binFile_);
        cout << color(sumColor) << "    ???????? ?? " << binFile_ << color(mainColor) << "\n";
    } catch (const exception& e) {
        cout << color(errColor) << "    ??????: " << e.what() << color(mainColor) << "\n";
    }

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "???????? ????????");
}

void App::doSwapFirstLastInFile() {
    cls();
    showNavBarMessage(hintColor, "    ???? ??????? ? ????????? ? ????");
    printList(getRequests(), "Current requests");

    try {
        requests_.swapFirstLastInFile(binFile_);
        cout << color(sumColor) << "    ?????? ? ????????? ??????? ??????? ? ?????\n" << color(mainColor);
    } catch (const exception& e) {
        cout << color(errColor) << "    ??????: " << e.what() << color(mainColor) << "\n";
    }

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "?????? ????????");
}

void App::doSwapEarliestLatestInFile() {
    cls();
    showNavBarMessage(hintColor, "    ???? ??????? ? ???????? ???");
    printList(getRequests(), "Current requests");

    try {
        requests_.swapEarliestLatestInFile(binFile_);
        cout << color(sumColor) << "    ??????? ? ??????????/???? ?????? ? ??? ?????\n" << color(mainColor);
    } catch (const exception& e) {
        cout << color(errColor) << "    ??????: " << e.what() << color(mainColor) << "\n";
    }

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "?????? ????????");
}
