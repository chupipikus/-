#include "App.h"
#include "Utils.h"

App::App() {}

void App::printList(const list<Request>& lst, const string& title) const {
    cout << "     " << title << "\n"
        << "     +" << setfill('-') << setw(112) << "-" << "+"
        << setfill(' ') << "\n";

    int row = 1;
    for (const auto& r : lst) {
        cout << " " << setfill('0') << setw(3) << row++ << setfill(' ')
            << " | ID: " << setw(2) << r.id
            << " | ?????: " << setw(19) << r.destination
            << " | ?????: " << setw(8) << r.flightNum
            << " | ????????: " << setw(15) << r.passenger
            << " | ?????: " << r.date.toString() << " |\n";
    }
    cout << "     +" << setfill('-') << setw(112) << "-" << "+"
        << setfill(' ') << "\n";
}

void App::doAddRequest() {
    cls();
    showNavBarMessage(hintColor, "    Add new flight ticket request");
    printList(getRequests(), "Current requests");

    cout << "\n    Enter new request data:\n";
    try {
        requests_.addRequestFromKeyboard();
        cout << color(sumColor) << "    Request added successfully\n" << color(mainColor);
    } catch (const exception& e) {
        cout << color(errColor) << "    Error: " << e.what() << color(mainColor) << "\n";
    }

    getKey("\n    Press any key to continue...");
    cls();
    printList(getRequests(), "Updated requests list");
}

void App::doDeleteById() {
    cls();
    showNavBarMessage(hintColor, "    Delete request by ID");
    printList(getRequests(), "Current requests");

    if (getRequests().empty()) {
        cout << color(errColor) << "    No requests\n" << color(mainColor);
        getKey();
        return;
    }

    cout << "\n    Enter request ID to delete: " << color(infoColor);
    int id;
    if (!(cin >> id)) {
        cin.clear();
        cin.ignore(cin.rdbuf()->in_avail(), '\n');
        cout << color(mainColor) << color(errColor) << "    Invalid ID input\n" << color(mainColor);
        getKey();
        return;
    }
    cin.ignore(cin.rdbuf()->in_avail(), '\n');
    cout << color(mainColor);

    try {
        requests_.deleteById(id);
        cout << color(sumColor) << "    Request ID " << id << " deleted\n" << color(mainColor);
    } catch (const exception& e) {
        cout << color(errColor) << "    Error: " << e.what() << color(mainColor) << "\n";
    }

    getKey("\n    Press any key to continue...");
    cls();
    printList(getRequests(), "Updated requests list");
}

void App::doSelectByFlight() {
    cls();
    showNavBarMessage(hintColor, "    Select requests by flight number");
    printList(getRequests(), "Current requests");

    if (getRequests().empty()) {
        cout << color(errColor) << "    No requests\n" << color(mainColor);
        getKey();
        return;
    }

    cout << "\n    Enter flight number (format PO-xxxxK): " << color(infoColor);
    string flight;
    getline(cin, flight);
    cout << color(mainColor);
    if (cin.fail()) {
        cin.clear();
        cin.ignore(cin.rdbuf()->in_avail(), '\n');
        cout << color(errColor) << "    Invalid input\n" << color(mainColor);
        getKey();
        return;
    }

    if (flight.empty()) {
        cout << color(errColor) << "    Flight number cannot be empty\n" << color(mainColor);
        getKey();
        return;
    }

    auto res = requests_.selectByFlight(flight);
    if (res.empty()) {
        cout << "    No requests found for flight: " << flight << "\n";
    } else {
        printList(res, "Requests for flight " + flight);
    }
    getKey();
}

void App::doSelectByDate() {
    cls();
    showNavBarMessage(hintColor, "    Select requests by date");
    printList(getRequests(), "Current requests");

    if (getRequests().empty()) {
        cout << color(errColor) << "    No requests\n" << color(mainColor);
        getKey();
        return;
    }

    cout << "\n    Enter date (day month year): " << color(infoColor);
    short day, month, year;
    if (!(cin >> day >> month >> year)) {
        cin.clear();
        cin.ignore(cin.rdbuf()->in_avail(), '\n');
        cout << color(mainColor) << color(errColor) << "    Invalid date input\n" << color(mainColor);
        getKey();
        return;
    }
    cin.ignore(cin.rdbuf()->in_avail(), '\n');
    cout << color(mainColor);

    if (day < 1 || day > 31 || month < 1 || month > 12 || year < 1900 || year > 2100) {
        cout << color(errColor) << "    Invalid date range: day=[1-31], month=[1-12], year=[1900-2100]\n" << color(mainColor);
        getKey();
        return;
    }

    try {
        Date date(day, month, year);
        auto res = requests_.selectByDate(date);
        if (res.empty()) {
            cout << "    No requests found for date: " << date.toString() << "\n";
        } else {
            printList(res, "Requests for date " + date.toString());
        }
    } catch (const exception& e) {
        cout << color(errColor) << "    Error: " << e.what() << color(mainColor) << "\n";
    }
    getKey();
}

void App::doSelectByPassenger() {
    cls();
    showNavBarMessage(hintColor, "    Select requests by passenger name");
    printList(getRequests(), "Current requests");

    if (getRequests().empty()) {
        cout << color(errColor) << "    No requests\n" << color(mainColor);
        getKey();
        return;
    }

    cout << "\n    Enter passenger name: " << color(infoColor);
    string pass;
    getline(cin, pass);
    cout << color(mainColor);
    if (cin.fail()) {
        cin.clear();
        cin.ignore(cin.rdbuf()->in_avail(), '\n');
        cout << color(errColor) << "    Invalid input\n" << color(mainColor);
        getKey();
        return;
    }

    if (pass.empty()) {
        cout << color(errColor) << "    Passenger name cannot be empty\n" << color(mainColor);
        getKey();
        return;
    }

    auto res = requests_.selectByPassenger(pass);
    if (res.empty()) {
        cout << "    No requests found for passenger: " << pass << "\n";
    } else {
        printList(res, "Requests for passenger " + pass);
    }
    getKey();
}

void App::doSortById() {
    cls();
    showNavBarMessage(hintColor, "    ?????????? ???????? ?? ID");
    printList(getRequests(), "Current requests");

    requests_.sortById();
    cout << color(sumColor) << "    ??????????? ?? ID\n" << color(mainColor);

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "??????????? ????????");
}

void App::doSortByDate() {
    cls();
    showNavBarMessage(hintColor, "    ?????????? ???????? ?? ????");
    printList(getRequests(), "Current requests");

    requests_.sortByDate();
    cout << color(sumColor) << "    ??????????? ?? ????\n" << color(mainColor);

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "??????????? ????????");
}

void App::doSortByDestination() {
    cls();
    showNavBarMessage(hintColor, "    ?????????? ???????? ?? ???????");
    printList(getRequests(), "Current requests");

    requests_.sortByDestination();
    cout << color(sumColor) << "    ??????????? ?? ???????\n" << color(mainColor);

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "??????????? ????????");
}

void App::doChangeRequest() {
    cls();
    showNavBarMessage(hintColor, "    ?????????? ????????");
    printList(getRequests(), "Current requests");

    if (getRequests().empty()) {
        cout << color(errColor) << "    ?????? ?????\n" << color(mainColor);
        getKey();
        return;
    }

    cout << "\n    ??????? ID ???????? ??? ??????????: " << color(infoColor);
    int id;
    if (!(cin >> id)) {
        cin.clear();
        cin.ignore(cin.rdbuf()->in_avail(), '\n');
        cout << color(mainColor) << color(errColor) << "    ???????? ?????? ID\n" << color(mainColor);
        getKey();
        return;
    }
    cin.ignore(cin.rdbuf()->in_avail(), '\n');

    cout << color(mainColor) << "\n    ??????? ????? ?????? ??????:\n";
    try {
        requests_.changeRequest(id);
        cout << color(sumColor) << "    ???????? ID " << id << " ?????? ?????????\n" << color(mainColor);
    } catch (const exception& e) {
        cout << color(errColor) << "    ??????: " << e.what() << color(mainColor) << "\n";
    }

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "?????????? ????????");
}

void App::doSaveToBinaryFixed() {
    cls();
    showNavBarMessage(hintColor, "    ?????? ???????? ? ???????? ????");
    printList(getRequests(), "Current requests");

    try {
        requests_.saveToBinaryFixed(binFile_);
        cout << color(sumColor) << "    ????????? ? " << binFile_ << color(mainColor) << "\n";
    } catch (const exception& e) {
        cout << color(errColor) << "    ??????: " << e.what() << color(mainColor) << "\n";
    }

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "?????? ????????");
}

void App::doLoadFromBinaryFixed() {
    cls();
    showNavBarMessage(hintColor, "    ???????? ???????? ?? ???????? ????");
    printList(getRequests(), "Current requests");

    try {
        requests_.loadFromBinaryFixed(binFile_);
        cout << color(sumColor) << "    ???????? ?? " << binFile_ << color(mainColor) << "\n";
    } catch (const exception& e) {
        cout << color(errColor) << "    ??????: " << e.what() << color(mainColor) << "\n";
    }

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "???????? ????????");
}

void App::doSwapFirstLastInFile() {
    cls();
    showNavBarMessage(hintColor, "    ???? ??????? ? ????????? ? ????");
    printList(getRequests(), "Current requests");

    try {
        requests_.swapFirstLastInFile(binFile_);
        cout << color(sumColor) << "    ?????? ? ????????? ??????? ??????? ? ?????\n" << color(mainColor);
    } catch (const exception& e) {
        cout << color(errColor) << "    ??????: " << e.what() << color(mainColor) << "\n";
    }

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "?????? ????????");
}

void App::doSwapEarliestLatestInFile() {
    cls();
    showNavBarMessage(hintColor, "    ???? ??????? ? ???????? ???");
    printList(getRequests(), "Current requests");

    try {
        requests_.swapEarliestLatestInFile(binFile_);
        cout << color(sumColor) << "    ??????? ? ??????????/???? ?????? ? ??? ?????\n" << color(mainColor);
    } catch (const exception& e) {
        cout << color(errColor) << "    ??????: " << e.what() << color(mainColor) << "\n";
    }

    getKey("\n    ??????? ????? ??????? ??? ???????...");
    cls();
    printList(getRequests(), "?????? ????????");
}
